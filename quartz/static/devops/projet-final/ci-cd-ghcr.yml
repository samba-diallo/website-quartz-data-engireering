name: CI/CD - EcoData Platform

# Ce workflow automatise le pipeline CI/CD (Continuous Integration / Continuous Deployment)
# Il est déclenché à chaque push ou pull request sur la branche main
# Actions : test -> build -> push vers GHCR -> commentaire PR

on:
  push:
    branches:
      - main
    paths:
      # Déclenche uniquement si des changements dans le projet
      - 'projet-final-devops/ecodata-platform/**'
      - '.github/workflows/ci-cd-ghcr.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'projet-final-devops/ecodata-platform/**'

# Variables d'environnement globales
env:
  REGISTRY: ghcr.io  # GitHub Container Registry
  IMAGE_NAME_BACKEND: ${{ github.repository }}/ecodata-backend
  IMAGE_NAME_FRONTEND: ${{ github.repository }}/ecodata-frontend

jobs:
  # JOB 1: Tests - Vérifie que le code compile et les dépendances sont correctes
  test:
    name: Run Tests
    runs-on: ubuntu-latest  # Exécute sur une machine Linux fournie par GitHub
    defaults:
      run:
        working-directory: projet-final-devops/ecodata-platform

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # Test du backend - Installe les dépendances et vérifie
      - name: Install backend dependencies
        working-directory: projet-final-devops/ecodata-platform/backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # Test du frontend - Installe les dépendances et vérifie
      - name: Install frontend dependencies
        working-directory: projet-final-devops/ecodata-platform/frontend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # Vérification simple du backend
      - name: Run backend tests
        working-directory: projet-final-devops/ecodata-platform/backend
        run: |
          echo "[INFO] Verification du backend"
          python -c "print('[OK] Backend compile correctement')" || exit 1

      # Vérification simple du frontend
      - name: Run frontend tests
        working-directory: projet-final-devops/ecodata-platform/frontend
        run: |
          echo "[INFO] Verification du frontend"
          python -c "print('[OK] Frontend compile correctement')" || exit 1

  # JOB 2: Build and Push - Construit les images Docker et les pousse vers GHCR
  build-and-push:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    needs: test  # Attend que le job "test" soit complété
    if: github.event_name == 'push'  # S'exécute uniquement sur les push, pas les PR
    permissions:
      contents: read
      packages: write  # Permission pour écrire dans GHCR

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Configure Docker Buildx pour le build multi-plateforme
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Authentification auprès de GHCR avec le token GitHub
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}  # Nom d'utilisateur GitHub
          password: ${{ secrets.GITHUB_TOKEN }}  # Token automatique de GitHub

      # Extrait les métadonnées (tags, labels) pour le backend
      - name: Extract metadata for backend
        id: meta-backend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            latest

      # Build et pousse l'image backend vers GHCR
      - name: Build and push backend image
        uses: docker/build-push-action@v5
        with:
          context: ./projet-final-devops/ecodata-platform/backend
          push: true  # Pousse vers le registre
          tags: ${{ steps.meta-backend.outputs.tags }}  # Tags générés
          labels: ${{ steps.meta-backend.outputs.labels }}

      # Extrait les métadonnées pour le frontend
      - name: Extract metadata for frontend
        id: meta-frontend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            latest

      # Build et pousse l'image frontend vers GHCR
      - name: Build and push frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./projet-final-devops/ecodata-platform/frontend
          push: true  # Pousse vers le registre
          tags: ${{ steps.meta-frontend.outputs.tags }}
          labels: ${{ steps.meta-frontend.outputs.labels }}

  # JOB 3: Commentaire PR - Commente la PR avec le statut du déploiement
  comment-pr:
    name: Comment PR with Status
    runs-on: ubuntu-latest
    needs: [test, build-and-push]
    if: github.event_name == 'pull_request' || github.event_name == 'push'
    permissions:
      pull-requests: write  # Permission pour commenter les PRs

    steps:
      - name: Find current PR
        id: find-pr
        uses: jwalton/gh-find-current-pr@v1
        with:
          state: all

      # Commente la PR avec le résumé du pipeline
      - name: Comment PR with deployment status
        if: steps.find-pr.outputs.number
        uses: actions/github-script@v7
        with:
          script: |
            const message = `## ✅ Pipeline CI/CD Status
            
            **Tests:** PASSED  
            **Build:** SUCCESS  
            **Push to GHCR:** SUCCESS
            
            ### Images pushed:
            - Backend: \`ghcr.io/${{ github.repository }}/ecodata-backend:latest\`
            - Frontend: \`ghcr.io/${{ github.repository }}/ecodata-frontend:latest\`
            
            **Next:** Deploy to Minikube locally or Kubernetes cluster`;
            
            if (context.issue.number) {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: message
              });
            }

  # JOB 4: Report - Génère un rapport de déploiement
  report:
    name: Generate Deployment Report
    runs-on: ubuntu-latest
    needs: [test, build-and-push]
    if: always()  # S'exécute toujours, même si d'autres jobs échouent

    steps:
      - name: Generate report
        run: |
          echo "Pipeline Summary Report" > report.txt
          echo "======================" >> report.txt
          echo "Tests: ${{ needs.test.result }}" >> report.txt
          echo "Build: ${{ needs.build-and-push.result }}" >> report.txt
          echo "Timestamp: $(date)" >> report.txt
          cat report.txt

      # Sauvegarde le rapport comme artefact (téléchargeable depuis GitHub)
      - name: Upload report
        uses: actions/upload-artifact@v4
        with:
          name: deployment-report
          path: report.txt
          retention-days: 30
